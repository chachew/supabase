_format_version: '2.1'
_transform: true

###
### Consumers / Users
###
consumers:
  - username: DASHBOARD
  - username: anon
    keyauth_credentials:
      - key: $SUPABASE_ANON_KEY
  - username: service_role
    keyauth_credentials:
      - key: $SUPABASE_SERVICE_KEY

###
### Access Control List
###
acls:
  - consumer: anon
    group: anon
  - consumer: service_role
    group: admin

###
### Dashboard credentials
###
basicauth_credentials:
  - consumer: DASHBOARD
    username: $DASHBOARD_USERNAME
    password: $DASHBOARD_PASSWORD

###
### API Routes
###
services:
  ## GoTrue: /auth/v1/* -> http://auth:9999/*
  - name: auth-service-go-true # Renamed for clarity
    url: http://$AUTH_HOST:9999 # This is the base URL of your GoTrue service
    routes:
      # Route for public auth endpoints (verify, signup, magiclink, etc.)
      - name: auth-public-routes
        paths:
          - /auth/v1/verify # Specific public paths for clarity
          - /auth/v1/signup
          - /auth/v1/magiclink
          # Add any other paths that should NOT require auth here
        strip_path: false # <<--- KEEP THIS FALSE! GoTrue needs the full path.
        # No plugins defined here, so it inherits from service.
        # But for public routes, you MUST explicitly disable auth plugins.
        plugins: # Explicitly disable auth for these routes
          - name: cors # Keep CORS for frontend
          - name: key-auth
            enabled: false # Disable key-auth for these specific paths
          - name: acl
            enabled: false # Disable ACL for these specific paths

      # Route for all other secure auth endpoints (/auth/v1/token, /auth/v1/user, etc.)
      - name: auth-secure-routes
        paths:
          - /auth/v1/ # This means any path starting with /auth/v1/
        strip_path: false # <<--- KEEP THIS FALSE!
        service: auth-service-go-true # Ensure it points to this service
        plugins:
          - name: cors # Keep CORS
          - name: key-auth # Re-enable key-auth for secure paths
            config:
              hide_credentials: false
          - name: acl # Re-enable ACL for secure paths
            config:
              hide_groups_header: true
              allow:
                - admin
                - anon